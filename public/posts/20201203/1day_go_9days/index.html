
<!DOCTYPE html>
<html lang="ja">
    
    


    
<head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.89.4" />

    
    
    

<title>たった1日で基本が身に付く！ Go言語 超入門@9日目 • Small Changes</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="たった1日で基本が身に付く！ Go言語 超入門@9日目"/>
<meta name="twitter:description" content="今日はついにゴルーチンです ゴルーチンってなんだ？ってところからですが、今日もやっていきます。 CHAPTER 8 Go言語の魅力を体験するプログラム 並列処理 考"/>

<meta property="og:title" content="たった1日で基本が身に付く！ Go言語 超入門@9日目" />
<meta property="og:description" content="今日はついにゴルーチンです ゴルーチンってなんだ？ってところからですが、今日もやっていきます。 CHAPTER 8 Go言語の魅力を体験するプログラム 並列処理 考" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://snyt45.com/posts/20201203/1day_go_9days/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-03T21:49:18+09:00" />
<meta property="article:modified_time" content="2020-12-03T21:49:18+09:00" /><meta property="og:site_name" content="Title" />



    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.3081c4981fb69a2783dd36ecfdd0e6ba7a158d4cbfdd290ebce8f78ba0469fc6.css" integrity="sha256-MIHEmB&#43;2mieD3Tbs/dDmunoVjUy/3SkOvOj3i6BGn8Y=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/tocbot.5ef07cebc3c477b54270456f149ee02922479bb7555fd344b2c69f953b0e7e5e.css" integrity="sha256-XvB868PEd7VCcEVvFJ7gKSJHm7dVX9NEssaflTsOfl4=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

    
    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FFNLJVXS4C"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FFNLJVXS4C');
</script>

    
    
    
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://snyt45.com/">Small Changes</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://snyt45.com/img/prof-icon-01.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Small Changes</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/snyt45" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/snyt45" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2020 - 2021 snyt45
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>たった1日で基本が身に付く！ Go言語 超入門@9日目</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020/12/03
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 5 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
        <div class="toc" id="TableOfContents"></div>
      
    </div>
  
  
  <div class="post">
    <p>今日はついにゴルーチンです</p>
<p>ゴルーチンってなんだ？ってところからですが、今日もやっていきます。</p>
<h2 id="chapter-8go言語の魅力を体験するプログラム">CHAPTER 8　Go言語の魅力を体験するプログラム</h2>
<h3 id="並列処理">並列処理</h3>
<ul>
<li>考え方は2つ
<ul>
<li>高速で大量の計算が必要なとき</li>
<li>時間がかかる操作をしている間に、他の操作を進めたいとき</li>
</ul>
</li>
</ul>
<h3 id="goroutineゴルーチン">goroutine(ゴルーチン)</h3>
<ul>
<li>ゴルーチンは、関数の実行時に<code>go</code>をつけることで、1つのスレッドとなる記法</li>
</ul>
<pre tabindex="0"><code>package main

import (
	&quot;fmt&quot;
	&quot;time&quot;
)

func count(name string, tlen int) {
	for i := 0; i &lt; 5; i++ {
		time.Sleep(time.Duration(tlen) * time.Millisecond)
		fmt.Printf(&quot;%sが%d匹\n&quot;, name, i+1)
	}
}

func main() {
	go count(&quot;カエル&quot;, 200) // 200ミリ秒ごとにカエルを数える
	go count(&quot;アヒル&quot;, 100) // 100ミリ秒ごとにアヒルを数える
}
</code></pre><ul>
<li><code>time.Duration(tlen) * time.Millisecond</code></li>
</ul>
<pre tabindex="0"><code>// 同じ型なので計算できる
time.Duration(tlen) * time.Millisecond
100000000
// int型とtime.Duration型なので計算できない
tlen * time.Millisecond
Unable to eval expression: &quot;mismatched types &quot;int&quot; and &quot;time.Duration&quot;&quot;
// ただ、後で出てくるが次のは計算できるみたい。。なぜ？
3000 * time.Millisecond
3000000000
</code></pre><ul>
<li>
<p>200ミリ秒ごとにカエル、100ミリ秒ごとにアヒルを数えるスレッドを並行させるプログラム</p>
</li>
<li>
<p>しかし、<code>ビルド・実行しても何も出力されない</code></p>
</li>
<li>
<p>ゴルーチンを呼び出しているのはmain関数。ゴルーチンとmain関数と並行で実行できるが、main関数は2つのゴルーチンを呼び出したあとすぐに終了してしまうので、結局ゴルーチンも終了してしまう。</p>
</li>
<li>
<p>次のようにmain関数に3000ミリ秒スリープしてもらうとゴルーチンも実行できる</p>
</li>
</ul>
<pre tabindex="0"><code>func main() {
	go count(&quot;カエル&quot;, 200)
	go count(&quot;アヒル&quot;, 100)
  time.Sleep(3000 * time.Millisecond) // この行を追加
}

// 実行結果
アヒルが1匹
アヒルが2匹
カエルが1匹
アヒルが3匹
カエルが2匹
アヒルが4匹
アヒルが5匹
カエルが3匹
カエルが4匹
カエルが5匹
</code></pre><h3 id="チャンネル">チャンネル</h3>
<ul>
<li>
<p>さっきの例はmain関数を寝かせておく変なプログラム</p>
</li>
<li>
<p>そこで用意されているのが<code>チャンネル</code>というデータ型</p>
</li>
<li>
<p>データ型の名前は<code>chan</code></p>
</li>
<li>
<p>チャンネルの基本的な使い方</p>
</li>
</ul>
<pre tabindex="0"><code>c := make(chan int)
c &lt;-1    // チャンネルに数値1を送る
r := &lt;-c // チャンネルから値を受け取る(1が代入される)
</code></pre><ul>
<li>望みの目が出るまでサイコロを振ることを意図したプログラム
<ul>
<li>構造体dice
<ul>
<li>valフィールドを持つ</li>
</ul>
</li>
<li>rollDice関数
<ul>
<li>valに設定した値が出るまでサイコロを振り続ける</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code>package main

import (
	&quot;fmt&quot;
	&quot;math/rand&quot;
	&quot;time&quot;
)

type dice struct {
	val int
}

func rollDice(d dice) {
	rand.Seed(time.Now().UnixNano()) // Seed生成。一度だけ設定すれば良いため戻り値を受け取る必要はない
	for {
		time.Sleep(10 * time.Millisecond) // 10ミリ秒スリープ
		if d.val == rand.Intn(10) { // 0～9までのランダムな整数を返す
			break // valと同じだった場合に無限ループを抜ける
		}
	}
	fmt.Printf(&quot;%dが出ました&quot;, d.val)
}

func main() {
	d1 := dice{2}
	d2 := dice{6}

	go rollDice(d1)
	go rollDice(d2)
}
</code></pre><ul>
<li>このプログラムだと先ほど同じくmain関数が終わると同時にゴルーチンも終了する</li>
<li>そこでチャンネルを使用するようにプログラムに変更を加える</li>
</ul>
<pre tabindex="0"><code>package main

import (
	&quot;fmt&quot;
	&quot;math/rand&quot;
	&quot;time&quot;
)

type dice struct {
	val int
}

func rollDice(d dice, c chan int) {
	rand.Seed(time.Now().UnixNano())
	for {
		time.Sleep(100 * time.Millisecond)
		v := rand.Intn(10)
		if d.val == v {
			fmt.Printf(&quot;出たー\n&quot;)
			break
		} else {
			fmt.Printf(&quot;%dか...%dではないな\n&quot;, v, d.val)
		}
	}
	c &lt;- d.val // 望みの目が出たら、チャンネルに渡す
}

func main() {
	d1 := dice{2}
	d2 := dice{6}

	c := make(chan int) // チャンネルを作成
	go rollDice(d1, c)  // 並行して動作
	go rollDice(d2, c)  // 並行して動作

	x, y := &lt;-c, &lt;-c // チャンネルの値を2回送る

	fmt.Printf(&quot;%dが出ました\n&quot;, x)
	fmt.Printf(&quot;%dが出ました\n&quot;, y)
}

// 実行結果
6か...2ではないな
4か...6ではないな
9か...2ではないな
4か...6ではないな
4か...6ではないな
7か...2ではないな
8か...2ではないな
2か...6ではないな
1か...6ではないな
6か...2ではないな
出たー           // go rollDice(d1, c)のほうが先に望みの目が出た。でもまだロックされている。
5か...6ではないな
0か...6ではないな
2か...6ではないな
0か...6ではないな
8か...6ではないな
0か...6ではないな
2か...6ではないな
4か...6ではないな
5か...6ではないな
9か...6ではないな
9か...6ではないな
8か...6ではないな
出たー           // go rollDice(d2, c)も望みの目が出た。これで、次の処理に進む
2が出ました
6が出ました
</code></pre><ul>
<li>チャンネルは自らの流れを管理してくれる。</li>
<li>送られた値の受けてがいないまま新たな値を送られても、そこでロックして待たせます</li>
<li>データが送られていないのに受け取りを要求されてもロックします</li>
</ul>
<h3 id="ちょっと脱線してgoのデバッグ環境を構築">ちょっと脱線してGoのデバッグ環境を構築</h3>
<ul>
<li><code>go get -u github.com/derekparker/delve/cmd/dlv</code>でdelveをインストール</li>
<li><code>dlv version</code>でバージョン確認</li>
<li>vscode-goはすでにインストール済み</li>
<li>Launch Debugでlaunch.jsonを作る。デフォルトでOK</li>
<li>ブレークポイントを打って、F5で実行。以上</li>
<li>変数の中身を見れたり、ステップで実行できたりができる。</li>
<li>ただ残念なことに関数呼び出しがまだできないみたい
<ul>
<li><a href="https://github.com/golang/vscode-go/issues/100">debug: support function calls via delve &lsquo;call&rsquo; · Issue #100 · golang/vscode-go</a></li>
</ul>
</li>
<li>vscode-goではなく直接delveを使ったほうがまだやれることは多かった。
<ul>
<li>delveでもcallで関数呼び出しは出来なかった・・・</li>
<li>whatis [変数名]で型が調べられるのは地味に楽</li>
<li><a href="https://qiita.com/minamijoyo/items/4da68467c1c5d94c8cd7">Golangのデバッガdelveの使い方 - Qiita</a></li>
</ul>
</li>
<li>rails consoleみたいに色々できないのだろうか…今のところかなり不便と感じる</li>
</ul>
<h2 id="今日の学び">今日の学び</h2>
<ul>
<li>Goの勉強をする中で、ライブラリを使いだすとすぐに自分の書いたコードがブラックボックスになる感覚に気が付いた。進めば進むほど、ライブラリは便利だがその反面楽をしすぎて考えることが減り、自分の成長機会を減らしていることに気づいた。楽をしない方法でできるだけ理解したコードを増やしてことを意識したい。</li>
<li>ゴルーチンのチャンネルについてざっくり分かった。少しずつ理解度をあげたい。</li>
</ul>
<h2 id="おまけ">おまけ</h2>
<ul>
<li><a href="https://yamatonamiki.com/blog/991/">プログラミングを上達させる、ロジックから考える勉強方法【脱初心者】</a>
<ul>
<li>ロジックから考える訓練が足りないのはマジだと思う…どうすればいいか</li>
</ul>
</li>
</ul>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/20201202/1day_go_8days/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">たった1日で基本が身に付く！ Go言語 超入門@8日目</span>
    </a>
    
    
    <a href="/posts/20201206/1day_go_10days/" class="navigation-next">
      <span class="navigation-tittle">たった1日で基本が身に付く！ Go言語 超入門@10日目</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.js"></script>
<script type="text/javascript">
  if (tocbot) {
    tocbot.init({
      
      tocSelector: '.toc',
      
      contentSelector: '.post',
      
      headingSelector: 'h2, h3, h4',
      collapseDepth: 4
    });
  }
</script>



    



        
        
    </body>
</html>
